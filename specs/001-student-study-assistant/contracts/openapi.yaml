openapi: 3.1.0
info:
  title: Student Study Assistant API
  version: 0.1.0
  description: Core endpoints for V1 (local file reference, notes, annotations, search, AI Q&A, logging correlation).
servers:
  - url: https://api.example.com
    description: Production (placeholder)
  - url: http://localhost:8000
    description: Local development
components:
  schemas:
    UUID:
      type: string
      format: uuid
    StudyMaterialType:
      type: string
      enum: [PDF, PPT, DOC, DOCX, WEB_ARTICLE, NOTE]
    ReferenceType:
      type: string
      enum: [LocalReference, WebArticle, Note]
    StudyMaterial:
      type: object
      required: [id, title, type, referenceType, ownerId, createdAt]
      properties:
        id: { $ref: '#/components/schemas/UUID' }
        ownerId: { $ref: '#/components/schemas/UUID' }
        title: { type: string, maxLength: 200 }
        type: { $ref: '#/components/schemas/StudyMaterialType' }
        referenceType: { $ref: '#/components/schemas/ReferenceType' }
        sizeBytes: { type: integer, minimum: 0 }
        tags: { type: array, items: { type: string, maxLength: 40 }, maxItems: 20 }
        collectionId: { $ref: '#/components/schemas/UUID' }
        lastIndexedAt: { type: string, format: date-time }
        headingOutline: { type: object }
        stale: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    Note:
      type: object
      required: [id, title, ownerId, createdAt]
      properties:
        id: { $ref: '#/components/schemas/UUID' }
        ownerId: { $ref: '#/components/schemas/UUID' }
        parentMaterialId: { $ref: '#/components/schemas/UUID' }
        title: { type: string, maxLength: 160 }
        contentRich: { type: object, description: 'Structured rich text (portable JSON)' }
        tags: { type: array, items: { type: string }, maxItems: 20 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    Annotation:
      type: object
      required: [id, materialId, ownerId, location, text, createdAt]
      properties:
        id: { $ref: '#/components/schemas/UUID' }
        materialId: { $ref: '#/components/schemas/UUID' }
        ownerId: { $ref: '#/components/schemas/UUID' }
        location:
          type: object
          properties:
            page: { type: integer, minimum: 1 }
            slide: { type: integer, minimum: 1 }
            anchor: { type: string }
        text: { type: string, maxLength: 1000 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    Conversation:
      type: object
      required: [id, ownerId, createdAt]
      properties:
        id: { $ref: '#/components/schemas/UUID' }
        ownerId: { $ref: '#/components/schemas/UUID' }
        title: { type: string }
        materialIds: { type: array, items: { $ref: '#/components/schemas/UUID' } }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    AIMessage:
      type: object
      required: [id, role, content, createdAt]
      properties:
        id: { $ref: '#/components/schemas/UUID' }
        conversationId: { $ref: '#/components/schemas/UUID' }
        role: { type: string, enum: [user, assistant, system] }
        content: { type: string }
        citations: { type: array, items: { $ref: '#/components/schemas/UUID' }, description: 'Referenced material or note IDs' }
        createdAt: { type: string, format: date-time }
    Error:
      type: object
      required: [code, message]
      properties:
        code: { type: string, maxLength: 60 }
        message: { type: string }
        details: { type: object }
        correlationId: { type: string }
    PageMeta:
      type: object
      required: [page, size, total]
      properties:
        page: { type: integer, minimum: 1 }
        size: { type: integer, minimum: 1 }
        total: { type: integer, minimum: 0 }
    PageOfStudyMaterial:
      type: object
      required: [items, meta]
      properties:
        items: { type: array, items: { $ref: '#/components/schemas/StudyMaterial' } }
        meta: { $ref: '#/components/schemas/PageMeta' }
    Envelope:
      type: object
      required: [data]
      properties:
        data: {}
        meta: { type: object }
        error: { $ref: '#/components/schemas/Error' }
    CreateLocalReferenceRequest:
      type: object
      required: [localPath, type]
      properties:
        localPath: { type: string, maxLength: 1024, description: 'Client-side path (never stored raw server-side; hashed)' }
        type: { $ref: '#/components/schemas/StudyMaterialType' }
        titleOverride: { type: string }
        tags: { type: array, items: { type: string } }
    RegisterWebArticleRequest:
      type: object
      required: [url]
      properties:
        url: { type: string, format: uri }
        titleOverride: { type: string }
        tags: { type: array, items: { type: string } }
    NoteCreateRequest:
      type: object
      required: [title, contentRich]
      properties:
        title: { type: string }
        contentRich: { type: object }
        parentMaterialId: { $ref: '#/components/schemas/UUID' }
        tags: { type: array, items: { type: string } }
    AnnotationCreateRequest:
      type: object
      required: [materialId, location, text]
      properties:
        materialId: { $ref: '#/components/schemas/UUID' }
        location: { type: object, properties: { page: { type: integer }, slide: { type: integer }, anchor: { type: string } } }
        text: { type: string, maxLength: 1000 }
    AIQuestionRequest:
      type: object
      required: [conversationId, prompt]
      properties:
        conversationId: { $ref: '#/components/schemas/UUID' }
        prompt: { type: string }
        materialIds: { type: array, items: { $ref: '#/components/schemas/UUID' }, description: 'Subset of materials to constrain context' }
    SearchQuery:
      type: object
      required: [q]
      properties:
        q: { type: string }
        tags: { type: array, items: { type: string } }
        includeStale: { type: boolean, default: false }
paths:
  /materials/local-reference:
    post:
      summary: Register local file reference
      operationId: createLocalReference
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateLocalReferenceRequest' }
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/StudyMaterial' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '409': { description: Duplicate reference, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /materials/web-article:
    post:
      summary: Register web article
      operationId: registerWebArticle
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterWebArticleRequest' }
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/StudyMaterial' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '422': { description: Unable to fetch article, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /materials/{id}:
    get:
      summary: Get material metadata
      operationId: getMaterial
      parameters:
        - in: path
          name: id
          required: true
          schema: { $ref: '#/components/schemas/UUID' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/StudyMaterial' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    delete:
      summary: Delete material
      operationId: deleteMaterial
      parameters:
        - in: path
          name: id
          required: true
          schema: { $ref: '#/components/schemas/UUID' }
      responses:
        '204': { description: Deleted }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /notes:
    post:
      summary: Create note
      operationId: createNote
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/NoteCreateRequest' }
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/Note' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /annotations:
    post:
      summary: Create annotation
      operationId: createAnnotation
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AnnotationCreateRequest' }
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/Annotation' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /search:
    post:
      summary: Search materials and notes
      operationId: search
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SearchQuery' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/PageOfStudyMaterial' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /ai/conversation:
    post:
      summary: Start AI conversation
      operationId: startConversation
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/Conversation' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /ai/question:
    post:
      summary: Ask question in AI conversation
      operationId: askQuestion
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AIQuestionRequest' }
      responses:
        '200': { description: Answer provided, content: { application/json: { schema: { $ref: '#/components/schemas/AIMessage' } } } }
        '400': { description: Validation error, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Conversation not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /health:
    get:
      summary: Health check
      operationId: health
      responses:
        '200': { description: OK }
        '503': { description: Unhealthy, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
